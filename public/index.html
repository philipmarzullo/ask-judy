<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Ask Judy â€” Your Meal Planning Bestie</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ‘©â€ğŸ³</text></svg>" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #FFF8F0; overflow: hidden; height: 100dvh; }
    #root { height: 100dvh; }
    @keyframes jbounce { 0%,60%,100%{transform:translateY(0)} 30%{transform:translateY(-6px)} }
    @keyframes spin { to { transform: rotate(360deg); } }
    textarea::placeholder { color: #B8A894; }
    input::placeholder { color: #C4B8A8; }
    textarea:focus, input:focus { outline: none; border-color: #FF8C42 !important; }
    button:active { opacity: 0.85; }
    .skill-btn:hover { background: #FFF3EB !important; border-color: #FFB88C !important; }
    .qp-btn:hover { background: #FFF3EB !important; border-color: #FF8C42 !important; }
    .mem-del:hover { background: #FFE0E0 !important; color: #D44 !important; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script type="text/babel">
    const { useState, useRef, useEffect, useCallback } = React;

    // â”€â”€â”€ Shared constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    const CATEGORY_LABELS = {
      preference: "ğŸ¯ Preference",
      dislike: "ğŸš« Dislike",
      favorite: "â­ Favorite",
      allergy: "âš ï¸ Allergy",
      family_info: "ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Family",
      schedule: "ğŸ“… Schedule",
      budget: "ğŸ’° Budget",
      cooking_tip: "ğŸ³ Cooking",
    };

    const SYSTEM_PROMPT = (profile, memories, userName) => {
      let pInfo = "";
      if (profile && Object.values(profile).some((v) => v)) {
        pInfo = `\n\nHere is what you know about ${userName}'s family:`;
        if (profile.familySize) pInfo += "\n- Family size: " + profile.familySize;
        if (profile.kidsAges) pInfo += "\n- Kids/ages: " + profile.kidsAges;
        if (profile.dietaryNeeds) pInfo += "\n- Dietary needs: " + profile.dietaryNeeds;
        if (profile.dislikes) pInfo += "\n- Dislikes: " + profile.dislikes;
        if (profile.budget) pInfo += "\n- Budget: " + profile.budget;
        if (profile.cookingLevel) pInfo += "\n- Cooking level: " + profile.cookingLevel;
        if (profile.busyNights) pInfo += "\n- Busy nights: " + profile.busyNights;
        if (profile.favorites) pInfo += "\n- Favorites: " + profile.favorites;
        if (profile.equipment) pInfo += "\n- Equipment: " + profile.equipment;
        pInfo += "\nUse this info to personalize suggestions naturally.";
      } else {
        pInfo = `\n\nYou don't know much about ${userName}'s family yet. Gently ask questions to learn more.`;
      }

      let mInfo = "";
      if (memories && memories.length > 0) {
        mInfo = `\n\nThings you've learned about ${userName}'s family from past conversations:`;
        memories.forEach((m) => {
          mInfo += "\n- " + m.memory;
        });
        mInfo += "\nWeave this knowledge naturally into your responses â€” don't list it back.";
      }

      return (
        `You are Judy, a warm, fun, and encouraging meal planning assistant. You are like a best friend in the kitchen. The user's name is ${userName}.\n\n` +
        "Personality: Warm, upbeat, supportive. You understand the struggles of keeping everything together. " +
        "Never judge. Casual friendly language. Celebrate small wins. Practical not aspirational. Light humor. Use emojis naturally but not excessively.\n\n" +
        "Skills:\n" +
        "- Meal Planning: Weekly plans tailored to family size, ages, picky eaters, schedule\n" +
        "- Grocery Lists: Organized by store section. Efficient, no random one-off ingredients\n" +
        "- Recipes: Easy family-friendly. Weeknight 30 min or less. Weekend fun meals too\n" +
        "- Budget-conscious: Smart swaps, batch cooking\n" +
        "- Leftovers strategy: Meals that build on each other\n" +
        "- Image support: Help with photos of fridge, pantry, recipes\n" +
        "- Teaching: Break things down simply, no chef jargon, encouraging baby steps\n" +
        "- School Lunches: If the user has school-age kids, help with packable lunches that stay fresh and aren't boring.\n" +
        pInfo +
        mInfo +
        `\n\nRemember: Help ${userName} feel like they've got this. Every interaction should leave them more confident.`
      );
    };

    const QUICK_PROMPTS = [
      { label: "ğŸ“… Plan my week", text: "Help me plan meals for this week!" },
      { label: "ğŸ›’ Grocery list", text: "I need a grocery list for the week" },
      { label: "â±ï¸ Quick dinner", text: "I need a quick dinner idea for tonight, 30 minutes or less!" },
      { label: "ğŸ± School lunches", text: "I need school lunch ideas for the week! Something easy to pack, stays fresh, and the kids will actually eat." },
      { label: "ğŸ“¸ What's in my fridge", text: "Let me show you what I have in my fridge, tell me what I can make!" },
    ];

    const SKILL_TOPICS = [
      { emoji: "ğŸ±", label: "School lunch ideas that aren't boring", text: "Teach me how to pack school lunches my kids will actually eat. I am tired of the same sandwich every day" },
      { emoji: "ğŸ§Š", label: "Lunchbox prep and what stays fresh", text: "Teach me what foods pack well for school lunches and stay good until lunchtime. What needs ice packs? What gets soggy? How do I prep the night before?" },
      { emoji: "ğŸ”ª", label: "Knife skills basics", text: "Teach me basic knife skills, how to chop, dice, and mince like I actually know what I am doing" },
      { emoji: "ğŸ§‚", label: "How to season food", text: "Teach me how to season food properly. I never know how much salt or spice to use" },
      { emoji: "ğŸ¥©", label: "How to tell when meat is done", text: "Teach me how to tell when meat is done cooking. I am always paranoid about undercooking" },
      { emoji: "ğŸ“¦", label: "Meal prep 101", text: "Teach me how to meal prep. I want to start but I do not know where to begin" },
      { emoji: "ğŸ³", label: "Cooking methods explained", text: "Teach me the difference between sauteing, braising, roasting, etc. in simple terms" },
      { emoji: "â„ï¸", label: "What can I freeze?", text: "Teach me what foods I can freeze and how to do it right so nothing goes to waste" },
      { emoji: "ğŸ’°", label: "Budget meal tricks", text: "Teach me how to eat well on a tight budget. What are the best bang-for-your-buck ingredients?" },
      { emoji: "ğŸ¥—", label: "Making veggies kids like", text: "Teach me tricks for getting kids to actually eat vegetables without a fight" },
    ];

    const PROFILE_FIELDS = [
      { key: "familySize", label: "How many people are you feeding?", icon: "ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦", hint: "e.g. 4 â€” me, husband, and 2 kids" },
      { key: "kidsAges", label: "Kids' ages?", icon: "ğŸ‘¶", hint: "e.g. 5 and 8 or toddler and teenager" },
      { key: "dietaryNeeds", label: "Any allergies or dietary needs?", icon: "âš ï¸", hint: "e.g. daughter is lactose intolerant" },
      { key: "dislikes", label: "Foods your family hates?", icon: "ğŸš«", hint: "e.g. kids won't touch mushrooms", multi: true },
      { key: "budget", label: "Grocery budget vibe?", icon: "ğŸ’°", hint: "e.g. trying to keep it under $150/week" },
      { key: "cookingLevel", label: "How comfortable in the kitchen?", icon: "ğŸ‘©â€ğŸ³", hint: "e.g. total beginner, can follow a recipe" },
      { key: "busyNights", label: "Which nights are craziest?", icon: "ğŸ“…", hint: "e.g. Tuesdays and Thursdays â€” soccer" },
      { key: "favorites", label: "Family favorite meals?", icon: "â­", hint: "e.g. tacos, mac and cheese, stir fry", multi: true },
      { key: "equipment", label: "Kitchen equipment?", icon: "ğŸ³", hint: "e.g. Instant Pot, air fryer, basic stuff" },
    ];

    // â”€â”€â”€ Auth helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    let _supabaseClient = null;

    async function getAccessToken() {
      if (!_supabaseClient) return null;
      // getSession returns cached token; refreshSession forces a fresh one if expired
      const { data } = await _supabaseClient.auth.getSession();
      return data.session?.access_token || null;
    }

    async function authFetch(url, options = {}) {
      const token = await getAccessToken();
      if (!token) throw new Error("Not authenticated");
      const res = await fetch(url, {
        ...options,
        headers: {
          ...options.headers,
          "Authorization": `Bearer ${token}`,
        },
      });
      // If token expired, refresh and retry once
      if (res.status === 401 && _supabaseClient) {
        const { data } = await _supabaseClient.auth.refreshSession();
        const newToken = data.session?.access_token;
        if (newToken) {
          return fetch(url, {
            ...options,
            headers: {
              ...options.headers,
              "Authorization": `Bearer ${newToken}`,
            },
          });
        }
      }
      return res;
    }

    // â”€â”€â”€ LoadingScreen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function LoadingScreen() {
      return (
        <div style={{ display: "flex", flexDirection: "column", alignItems: "center", justifyContent: "center", height: "100dvh", background: "linear-gradient(180deg,#FFF8F0 0%,#FFF 40%)" }}>
          <div style={{ fontSize: 64, marginBottom: 16 }}>ğŸ‘©â€ğŸ³</div>
          <div style={{ fontSize: 16, color: "#8B7B6B" }}>Loading...</div>
        </div>
      );
    }

    // â”€â”€â”€ LoginScreen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function LoginScreen({ supabaseClient }) {
      const [email, setEmail] = useState("");
      const [password, setPassword] = useState("");
      const [mode, setMode] = useState("signin"); // signin | signup | forgot | reset_sent
      const [error, setError] = useState("");
      const [submitting, setSubmitting] = useState(false);

      const handleSubmit = async () => {
        if (!email.trim() || (!password && mode !== "forgot")) return;
        setSubmitting(true);
        setError("");

        if (mode === "forgot") {
          const { error: err } = await supabaseClient.auth.resetPasswordForEmail(email.trim(), {
            redirectTo: window.location.origin,
          });
          setSubmitting(false);
          if (err) { setError(err.message); } else { setMode("reset_sent"); }
          return;
        }

        let result;
        if (mode === "signup") {
          result = await supabaseClient.auth.signUp({ email: email.trim(), password });
          // If email confirmation is still on, signUp succeeds but session is null
          if (!result.error && !result.data.session) {
            setSubmitting(false);
            setError("Account created! Check your email to confirm, then sign in.");
            setMode("signin");
            return;
          }
        } else {
          result = await supabaseClient.auth.signInWithPassword({ email: email.trim(), password });
        }

        setSubmitting(false);
        if (result.error) {
          setError(result.error.message);
        }
      };

      return (
        <div style={{ display: "flex", flexDirection: "column", alignItems: "center", justifyContent: "center", height: "100dvh", background: "linear-gradient(180deg,#FFF8F0 0%,#FFF 40%)", padding: "0 24px" }}>
          <div style={{ fontSize: 64, marginBottom: 12 }}>ğŸ‘©â€ğŸ³</div>
          <h1 style={{ fontSize: 26, fontWeight: 700, color: "#2D2D2D", marginBottom: 6 }}>Ask Judy</h1>
          <p style={{ color: "#8B7B6B", fontSize: 14, marginBottom: 32, textAlign: "center" }}>Your meal planning bestie</p>

          {mode === "reset_sent" ? (
            <div style={{ textAlign: "center", maxWidth: 340 }}>
              <div style={{ fontSize: 48, marginBottom: 12 }}>ğŸ“¬</div>
              <h2 style={{ fontSize: 20, fontWeight: 700, color: "#2D2D2D", marginBottom: 8 }}>Check your email!</h2>
              <p style={{ color: "#8B7B6B", fontSize: 14, lineHeight: 1.5 }}>
                We sent a password reset link to <strong>{email}</strong>.
              </p>
              <button onClick={() => setMode("signin")} style={{ marginTop: 20, padding: "10px 20px", borderRadius: 12, border: "1.5px solid #E8DDD0", background: "white", color: "#8B7B6B", fontSize: 14, cursor: "pointer" }}>
                Back to Sign In
              </button>
            </div>
          ) : (
            <div style={{ width: "100%", maxWidth: 340 }}>
              <input
                type="email"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                placeholder="Email"
                style={{ width: "100%", padding: "14px 16px", borderRadius: 14, border: "1.5px solid #E8DDD0", fontSize: 16, fontFamily: "inherit", background: "#FFFCF8", outline: "none", marginBottom: 10 }}
              />
              {mode !== "forgot" && (
                <input
                  type="password"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  onKeyDown={(e) => { if (e.key === "Enter") handleSubmit(); }}
                  placeholder={mode === "signup" ? "Choose a password (6+ characters)" : "Password"}
                  style={{ width: "100%", padding: "14px 16px", borderRadius: 14, border: "1.5px solid #E8DDD0", fontSize: 16, fontFamily: "inherit", background: "#FFFCF8", outline: "none", marginBottom: 12 }}
                />
              )}
              {error && <p style={{ color: "#D44", fontSize: 13, marginBottom: 12 }}>{error}</p>}
              <button
                onClick={handleSubmit}
                disabled={submitting || !email.trim() || (!password && mode !== "forgot")}
                style={{ width: "100%", padding: 14, borderRadius: 14, border: "none", background: (email.trim() && (password || mode === "forgot")) ? "linear-gradient(135deg,#FF8C42,#FF6B35)" : "#DDD", color: "white", fontSize: 16, fontWeight: 600, cursor: submitting ? "wait" : "pointer", marginBottom: 12 }}>
                {submitting ? "Please wait..." : mode === "signup" ? "Create Account" : mode === "forgot" ? "Send Reset Link" : "Sign In"}
              </button>
              {mode === "signin" && (
                <p style={{ textAlign: "center", fontSize: 13, color: "#B8A894", marginBottom: 8 }}>
                  <span onClick={() => { setMode("forgot"); setError(""); }} style={{ cursor: "pointer", textDecoration: "underline" }}>Forgot password?</span>
                </p>
              )}
              <p style={{ textAlign: "center", fontSize: 14, color: "#8B7B6B" }}>
                {mode === "signup" ? "Already have an account? " : mode === "forgot" ? "Remember it? " : "Don't have an account? "}
                <span onClick={() => { setMode(mode === "signup" ? "signin" : mode === "forgot" ? "signin" : "signup"); setError(""); }} style={{ color: "#E8652A", fontWeight: 600, cursor: "pointer" }}>
                  {mode === "signup" ? "Sign In" : mode === "forgot" ? "Sign In" : "Sign Up"}
                </span>
              </p>
            </div>
          )}
        </div>
        </div>
      );
    }

    // â”€â”€â”€ OnboardingScreen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    const ONBOARDING_STEPS = [
      { key: "name", label: "What should Judy call you?", placeholder: "Your first name", icon: "ğŸ‘‹", hint: "Just your first name is great!" },
      { key: "familySize", label: "Who are you feeding?", placeholder: "e.g. Me, husband, and 2 kids (4 total)", icon: "ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦", hint: "Judy tailors portions and recipes to your crew size" },
      { key: "kidsAges", label: "Any kids? How old?", placeholder: "e.g. 5 and 8, or just me and my partner", icon: "ğŸ‘¶", hint: "Helps Judy suggest age-appropriate meals and lunches" },
      { key: "dietaryNeeds", label: "Allergies or dietary needs?", placeholder: "e.g. Nut allergy, vegetarian, none", icon: "âš ï¸", hint: "Safety first! Judy will always respect these" },
      { key: "cookingLevel", label: "How comfortable are you in the kitchen?", placeholder: "e.g. Total beginner, can follow a recipe, pretty confident", icon: "ğŸ‘©â€ğŸ³", hint: "No judgment! Judy meets you where you are" },
      { key: "busyNights", label: "Which nights are craziest?", placeholder: "e.g. Tuesdays and Thursdays â€” soccer practice", icon: "ğŸ“…", hint: "Judy will plan quick meals on your busy nights" },
    ];

    function OnboardingScreen({ onComplete }) {
      const [step, setStep] = useState(0);
      const [answers, setAnswers] = useState({ name: "", familySize: "", kidsAges: "", dietaryNeeds: "", cookingLevel: "", busyNights: "" });
      const [saving, setSaving] = useState(false);

      const current = ONBOARDING_STEPS[step];
      const isLast = step === ONBOARDING_STEPS.length - 1;
      const isFirst = step === 0;
      const val = answers[current.key].trim();

      const handleNext = async () => {
        if (isFirst && !val) return;
        if (isLast) {
          setSaving(true);
          try {
            await authFetch("/api/profile", {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                name: answers.name.trim(),
                familySize: answers.familySize.trim(),
                kidsAges: answers.kidsAges.trim(),
                dietaryNeeds: answers.dietaryNeeds.trim(),
                cookingLevel: answers.cookingLevel.trim(),
                busyNights: answers.busyNights.trim(),
              }),
            });
            onComplete(answers.name.trim());
          } catch (e) {
            console.error("Onboarding save error:", e);
            setSaving(false);
          }
        } else {
          setStep(step + 1);
        }
      };

      const handleSkip = () => {
        if (isLast) {
          handleNext();
        } else {
          setStep(step + 1);
        }
      };

      return (
        <div style={{ display: "flex", flexDirection: "column", alignItems: "center", justifyContent: "center", height: "100dvh", background: "linear-gradient(180deg,#FFF8F0 0%,#FFF 40%)", padding: "0 24px" }}>
          <div style={{ fontSize: 56, marginBottom: 8 }}>{current.icon}</div>
          <h1 style={{ fontSize: 20, fontWeight: 700, color: "#2D2D2D", marginBottom: 4, textAlign: "center" }}>{current.label}</h1>
          <p style={{ color: "#B8A894", fontSize: 13, marginBottom: 24, textAlign: "center" }}>{current.hint}</p>

          {/* Progress dots */}
          <div style={{ display: "flex", gap: 6, marginBottom: 20 }}>
            {ONBOARDING_STEPS.map((_, i) => (
              <div key={i} style={{ width: 8, height: 8, borderRadius: "50%", background: i === step ? "#FF8C42" : i < step ? "#FFD4B8" : "#E8DDD0" }} />
            ))}
          </div>

          <div style={{ width: "100%", maxWidth: 360 }}>
            <input
              key={current.key}
              type="text"
              value={answers[current.key]}
              onChange={(e) => setAnswers((a) => ({ ...a, [current.key]: e.target.value }))}
              onKeyDown={(e) => { if (e.key === "Enter") handleNext(); }}
              placeholder={current.placeholder}
              autoFocus
              style={{ width: "100%", padding: "14px 16px", borderRadius: 14, border: "1.5px solid #E8DDD0", fontSize: 16, fontFamily: "inherit", background: "#FFFCF8", outline: "none", marginBottom: 12 }}
            />
            <button
              onClick={handleNext}
              disabled={saving || (isFirst && !val)}
              style={{ width: "100%", padding: 14, borderRadius: 14, border: "none", background: (isFirst && !val) ? "#DDD" : "linear-gradient(135deg,#FF8C42,#FF6B35)", color: "white", fontSize: 16, fontWeight: 600, cursor: saving ? "wait" : "pointer", marginBottom: 8 }}>
              {saving ? "Setting up..." : isLast ? "Done â€” Let's Cook!" : "Next"}
            </button>
            <div style={{ display: "flex", justifyContent: "space-between" }}>
              {step > 0 ? (
                <button onClick={() => setStep(step - 1)} style={{ padding: "8px 16px", borderRadius: 12, border: "none", background: "transparent", color: "#B8A894", fontSize: 13, cursor: "pointer" }}>
                  â† Back
                </button>
              ) : <div />}
              {!isFirst && (
                <button onClick={handleSkip} style={{ padding: "8px 16px", borderRadius: 12, border: "none", background: "transparent", color: "#B8A894", fontSize: 13, cursor: "pointer" }}>
                  Skip â†’
                </button>
              )}
            </div>
          </div>
        </div>
      );
    }

    // â”€â”€â”€ AskJudy (main app) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function AskJudy({ session, userName, supabaseClient }) {
      const [msgs, setMsgs] = useState([]);
      const [input, setInput] = useState("");
      const [loading, setLoading] = useState(false);
      const [images, setImages] = useState([]);
      const [welcome, setWelcome] = useState(true);
      const [profile, setProfile] = useState({
        familySize: "", kidsAges: "", dietaryNeeds: "", dislikes: "",
        budget: "", cookingLevel: "", busyNights: "", favorites: "", equipment: "",
      });
      const [memories, setMemories] = useState([]);
      const [panel, setPanel] = useState(null);
      const [saved, setSaved] = useState(false);
      const [convoId, setConvoId] = useState(null);
      const [convoList, setConvoList] = useState([]);
      const endRef = useRef(null);
      const fileRef = useRef(null);
      const taRef = useRef(null);

      // Load profile, memories, and most recent conversation on mount
      useEffect(() => {
        authFetch("/api/profile")
          .then((r) => r.json())
          .then((data) => {
            if (data.profile) {
              setProfile({
                familySize: data.profile.family_size || "",
                kidsAges: data.profile.kids_ages || "",
                dietaryNeeds: data.profile.dietary_needs || "",
                dislikes: data.profile.dislikes || "",
                budget: data.profile.budget || "",
                cookingLevel: data.profile.cooking_level || "",
                busyNights: data.profile.busy_nights || "",
                favorites: data.profile.favorites || "",
                equipment: data.profile.equipment || "",
              });
              setSaved(true);
            }
          })
          .catch(() => {});

        authFetch("/api/memories")
          .then((r) => r.json())
          .then((data) => { if (data.memories) setMemories(data.memories); })
          .catch(() => {});

        // Load conversation list and restore the most recent one
        loadConversations(true);
      }, []);

      const loadConversations = async (restoreLast) => {
        try {
          const r = await authFetch("/api/conversations");
          const data = await r.json();
          const list = data.conversations || [];
          setConvoList(list);
          if (restoreLast && list.length > 0) {
            // Load the most recent conversation's messages
            const latest = list[0];
            setConvoId(latest.id);
            // Fetch full conversation to get messages
            const r2 = await authFetch(`/api/conversations/${latest.id}`);
            const d2 = await r2.json();
            if (d2.conversation && d2.conversation.messages && d2.conversation.messages.length > 0) {
              setMsgs(d2.conversation.messages);
              setWelcome(false);
            }
          }
        } catch (e) {}
      };

      const saveConversation = async (updatedMsgs, isNew) => {
        // Strip base64 image data before saving (too large for DB)
        const saveMsgs = updatedMsgs.map((m) => {
          if (m._imgs || (Array.isArray(m.content) && m.content.some((c) => c.type === "image"))) {
            return { role: m.role, content: m._text || m.content, _text: m._text };
          }
          return { role: m.role, content: m.content, _text: m._text };
        });

        // Generate title from first user message
        const firstUserText = updatedMsgs.find((m) => m.role === "user")?._text || "New conversation";
        const title = firstUserText.slice(0, 60) + (firstUserText.length > 60 ? "..." : "");

        try {
          if (convoId && !isNew) {
            await authFetch(`/api/conversations/${convoId}`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ messages: saveMsgs, title }),
            });
          } else {
            const r = await authFetch("/api/conversations", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ messages: saveMsgs, title }),
            });
            const data = await r.json();
            if (data.conversation) setConvoId(data.conversation.id);
          }
          // Refresh the list
          const r = await authFetch("/api/conversations");
          const data = await r.json();
          setConvoList(data.conversations || []);
        } catch (e) {}
      };

      const startNewConvo = () => {
        setConvoId(null);
        setMsgs([]);
        setWelcome(true);
        setPanel(null);
      };

      const loadConvo = async (id) => {
        try {
          const r = await authFetch(`/api/conversations/${id}`);
          const data = await r.json();
          if (data.conversation) {
            setConvoId(data.conversation.id);
            setMsgs(data.conversation.messages || []);
            setWelcome(false);
            setPanel(null);
          }
        } catch (e) {}
      };

      const deleteConvo = async (id) => {
        try {
          await authFetch(`/api/conversations/${id}`, { method: "DELETE" });
          setConvoList((prev) => prev.filter((c) => c.id !== id));
          if (convoId === id) startNewConvo();
        } catch (e) {}
      };

      useEffect(() => { endRef.current?.scrollIntoView({ behavior: "smooth" }); }, [msgs, loading]);

      useEffect(() => {
        if (taRef.current) {
          taRef.current.style.height = "auto";
          taRef.current.style.height = Math.min(taRef.current.scrollHeight, 120) + "px";
        }
      }, [input]);

      const saveProfile = async () => {
        try {
          await authFetch("/api/profile", {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ ...profile, name: userName }),
          });
        } catch (e) {}
        setSaved(true);
        setPanel(null);
      };

      const deleteMemory = async (id) => {
        try {
          await authFetch(`/api/memories/${id}`, { method: "DELETE" });
          setMemories((prev) => prev.filter((m) => m.id !== id));
        } catch (e) {}
      };

      const refreshMemories = () => {
        authFetch("/api/memories")
          .then((r) => r.json())
          .then((data) => { if (data.memories) setMemories(data.memories); })
          .catch(() => {});
      };

      const onFiles = (e) => {
        Array.from(e.target.files).forEach((f) => {
          if (!f.type.startsWith("image/")) return;
          const r = new FileReader();
          r.onload = (ev) => {
            setImages((p) => [...p, {
              base64: ev.target.result.split(",")[1],
              type: f.type, preview: ev.target.result,
            }]);
          };
          r.readAsDataURL(f);
        });
        if (fileRef.current) fileRef.current.value = "";
      };

      const handleSignOut = async () => {
        await supabaseClient.auth.signOut();
      };

      const send = async (override) => {
        const text = override || input.trim();
        if (!text && images.length === 0) return;
        setWelcome(false);
        setPanel(null);

        const content = [];
        images.forEach((img) => {
          content.push({ type: "image", source: { type: "base64", media_type: img.type, data: img.base64 } });
        });
        if (text) content.push({ type: "text", text });

        const userMsg = { role: "user", content, _text: text, _imgs: images.map((i) => i.preview) };
        const updated = [...msgs, userMsg];
        setMsgs(updated);
        setInput("");
        setImages([]);
        setLoading(true);

        try {
          const apiMsgs = updated.map((m) => ({ role: m.role, content: m.content }));
          const res = await authFetch("/api/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              model: "claude-sonnet-4-20250514",
              max_tokens: 1500,
              system: SYSTEM_PROMPT(profile, memories, userName),
              messages: apiMsgs,
            }),
          });
          const data = await res.json();
          if (data.error) throw new Error(data.error.message || "API error");
          const txt = (data.content || []).filter((b) => b.type === "text").map((b) => b.text).join("\n");
          const assistantMsg = { role: "assistant", content: txt || "Hmm, hit a snag. Try again!", _text: txt };
          const finalMsgs = [...updated, assistantMsg];
          setMsgs(finalMsgs);
          // Save conversation to DB
          saveConversation(finalMsgs, !convoId);
          // Refresh memories after a short delay (gives extraction time to complete)
          setTimeout(refreshMemories, 3000);
        } catch (e) {
          setMsgs((p) => [...p, { role: "assistant", content: "Oops! Something went wrong. Try again? ğŸ’›", _text: "Oops! Something went wrong. Try again? ğŸ’›" }]);
        } finally {
          setLoading(false);
        }
      };

      const fmt = (text) => {
        if (!text) return null;
        return text.split("\n").map((line, i) => {
          let h = line.replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>").replace(/\*(.*?)\*/g, "<em>$1</em>");
          if (line.startsWith("### ")) return <h4 key={i} style={{ margin: "8px 0 4px", fontSize: 15, fontWeight: 700 }}>{line.slice(4)}</h4>;
          if (line.startsWith("## ")) return <h3 key={i} style={{ margin: "10px 0 4px", fontSize: 16, fontWeight: 700 }}>{line.slice(3)}</h3>;
          if (line.startsWith("# ")) return <h2 key={i} style={{ margin: "12px 0 6px", fontSize: 18, fontWeight: 700 }}>{line.slice(2)}</h2>;
          if (/^[-â€¢]\s/.test(line)) return <div key={i} style={{ paddingLeft: 12, marginBottom: 2 }} dangerouslySetInnerHTML={{ __html: "â€¢ " + h.slice(2) }} />;
          if (/^\d+\.\s/.test(line)) return <div key={i} style={{ paddingLeft: 12, marginBottom: 2 }} dangerouslySetInnerHTML={{ __html: h }} />;
          if (!line.trim()) return <br key={i} />;
          return <p key={i} style={{ margin: "2px 0" }} dangerouslySetInnerHTML={{ __html: h }} />;
        });
      };

      return (
        <div style={{ display: "flex", flexDirection: "column", height: "100dvh", background: "linear-gradient(180deg,#FFF8F0 0%,#FFF 40%)", position: "relative" }}>
          {/* Header */}
          <div style={{ padding: "10px 16px", borderBottom: "1px solid #F0E6D9", background: "white", display: "flex", alignItems: "center", gap: 8, flexShrink: 0 }}>
            <div style={{ width: 36, height: 36, borderRadius: "50%", background: "#FFF3EB", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 20 }}>ğŸ‘©â€ğŸ³</div>
            <div style={{ flex: 1 }}>
              <div style={{ fontWeight: 700, fontSize: 16, color: "#2D2D2D" }}>Ask Judy</div>
            </div>
            <button onClick={startNewConvo}
              style={{ padding: "6px 10px", borderRadius: 16, background: "transparent", color: "#8B7B6B", border: "1.5px solid #E8DDD0", fontSize: 12, fontWeight: 500, cursor: "pointer" }}>
              + New
            </button>
            <button onClick={() => { setPanel(panel === "chats" ? null : "chats"); if (panel !== "chats") loadConversations(false); }}
              style={{ padding: "6px 10px", borderRadius: 16, background: panel === "chats" ? "#FFF3EB" : "transparent", color: panel === "chats" ? "#E8652A" : "#8B7B6B", border: panel === "chats" ? "1.5px solid #FFD4B8" : "1.5px solid #E8DDD0", fontSize: 12, fontWeight: 500, cursor: "pointer" }}>
              ğŸ’¬{convoList.length > 0 && <span style={{ marginLeft: 2, fontSize: 10 }}>{convoList.length}</span>}
            </button>
            <button onClick={() => setPanel(panel === "family" ? null : "family")}
              style={{ padding: "6px 10px", borderRadius: 16, background: panel === "family" ? "#FFF3EB" : "transparent", color: panel === "family" ? "#E8652A" : "#8B7B6B", border: panel === "family" ? "1.5px solid #FFD4B8" : "1.5px solid #E8DDD0", fontSize: 12, fontWeight: 500, cursor: "pointer" }}>
              ğŸ 
            </button>
            <button onClick={() => { setPanel(panel === "memory" ? null : "memory"); if (panel !== "memory") refreshMemories(); }}
              style={{ padding: "6px 10px", borderRadius: 16, background: panel === "memory" ? "#FFF3EB" : "transparent", color: panel === "memory" ? "#E8652A" : "#8B7B6B", border: panel === "memory" ? "1.5px solid #FFD4B8" : "1.5px solid #E8DDD0", fontSize: 12, fontWeight: 500, cursor: "pointer", position: "relative" }}>
              ğŸ§ {memories.length > 0 && <span style={{ marginLeft: 2, fontSize: 10 }}>{memories.length}</span>}
            </button>
            <button onClick={() => setPanel(panel === "skills" ? null : "skills")}
              style={{ padding: "6px 10px", borderRadius: 16, background: panel === "skills" ? "#FFF3EB" : "transparent", color: panel === "skills" ? "#E8652A" : "#8B7B6B", border: panel === "skills" ? "1.5px solid #FFD4B8" : "1.5px solid #E8DDD0", fontSize: 12, fontWeight: 500, cursor: "pointer" }}>
              ğŸ“š
            </button>
            <button onClick={handleSignOut}
              style={{ width: 32, height: 32, borderRadius: "50%", background: "transparent", color: "#B8A894", border: "1.5px solid #E8DDD0", fontSize: 14, cursor: "pointer", display: "flex", alignItems: "center", justifyContent: "center", padding: 0 }}
              title="Sign out">
              â†ª
            </button>
          </div>

          {/* Chats Panel */}
          {panel === "chats" && (
            <div style={{ position: "absolute", top: 57, left: 0, right: 0, bottom: 0, background: "white", zIndex: 10, overflowY: "auto", padding: "20px 16px" }}>
              <div style={{ maxWidth: 500, margin: "0 auto" }}>
                <div style={{ textAlign: "center", marginBottom: 20 }}>
                  <div style={{ fontSize: 36, marginBottom: 8 }}>ğŸ’¬</div>
                  <h2 style={{ fontSize: 20, fontWeight: 700, color: "#2D2D2D", marginBottom: 6 }}>Your Conversations</h2>
                  <p style={{ color: "#8B7B6B", fontSize: 13, lineHeight: 1.5 }}>Pick up where you left off or start fresh.</p>
                </div>
                <button onClick={() => { startNewConvo(); setPanel(null); }}
                  style={{ width: "100%", padding: 14, borderRadius: 14, border: "1.5px dashed #FFD4B8", background: "#FFF8F0", color: "#E8652A", fontSize: 15, fontWeight: 600, cursor: "pointer", marginBottom: 16 }}>
                  + Start New Conversation
                </button>
                {convoList.length === 0 ? (
                  <div style={{ textAlign: "center", padding: "40px 20px" }}>
                    <div style={{ fontSize: 40, marginBottom: 12 }}>ğŸ’­</div>
                    <p style={{ color: "#8B7B6B", fontSize: 14, lineHeight: 1.5 }}>
                      No conversations yet! Start chatting with Judy.
                    </p>
                  </div>
                ) : (
                  <div style={{ display: "flex", flexDirection: "column", gap: 8, marginBottom: 40 }}>
                    {convoList.map((c) => (
                      <div key={c.id} style={{ display: "flex", alignItems: "center", gap: 10, padding: "12px 14px", borderRadius: 12, border: convoId === c.id ? "1.5px solid #FFD4B8" : "1.5px solid #F0E6D9", background: convoId === c.id ? "#FFF8F0" : "#FFFCF8", cursor: "pointer" }}
                        onClick={() => loadConvo(c.id)}>
                        <div style={{ flex: 1 }}>
                          <div style={{ fontSize: 14, fontWeight: 500, color: "#3D3D3D", lineHeight: 1.4 }}>{c.title || "Untitled"}</div>
                          <div style={{ fontSize: 11, color: "#B8A894", marginTop: 2 }}>{new Date(c.updated_at).toLocaleDateString(undefined, { month: "short", day: "numeric", hour: "numeric", minute: "2-digit" })}</div>
                        </div>
                        <button onClick={(e) => { e.stopPropagation(); deleteConvo(c.id); }} className="mem-del"
                          style={{ padding: "4px 8px", borderRadius: 8, border: "1px solid #E8DDD0", background: "#FFF", color: "#B8936A", fontSize: 12, cursor: "pointer", flexShrink: 0 }}>
                          âœ•
                        </button>
                      </div>
                    ))}
                  </div>
                )}
                <div style={{ marginBottom: 40 }}>
                  <button onClick={() => setPanel(null)} style={{ width: "100%", padding: 14, borderRadius: 14, border: "1.5px solid #E8DDD0", background: "white", color: "#8B7B6B", fontSize: 15, cursor: "pointer" }}>Back</button>
                </div>
              </div>
            </div>
          )}

          {/* Family Panel */}
          {panel === "family" && (
            <div style={{ position: "absolute", top: 57, left: 0, right: 0, bottom: 0, background: "white", zIndex: 10, overflowY: "auto", padding: "20px 16px" }}>
              <div style={{ maxWidth: 500, margin: "0 auto" }}>
                <div style={{ textAlign: "center", marginBottom: 20 }}>
                  <div style={{ fontSize: 36, marginBottom: 8 }}>ğŸ </div>
                  <h2 style={{ fontSize: 20, fontWeight: 700, color: "#2D2D2D", marginBottom: 6 }}>Tell Judy About Your Family</h2>
                  <p style={{ color: "#8B7B6B", fontSize: 13, lineHeight: 1.5 }}>The more Judy knows, the better she can help!</p>
                </div>
                {PROFILE_FIELDS.map((f) => (
                  <div key={f.key} style={{ marginBottom: 14 }}>
                    <label style={{ fontSize: 13, fontWeight: 600, color: "#5A4A3A", display: "block", marginBottom: 4 }}>{f.icon} {f.label}</label>
                    <div style={{ fontSize: 11, color: "#9B8A7A", marginBottom: 4 }}>{f.hint}</div>
                    {f.multi ? (
                      <textarea value={profile[f.key]} onChange={(e) => setProfile((p) => ({ ...p, [f.key]: e.target.value }))} rows={2}
                        style={{ width: "100%", padding: "10px 12px", borderRadius: 10, border: "1.5px solid #E8DDD0", fontSize: 14, fontFamily: "inherit", background: "#FFFCF8", resize: "none", outline: "none" }} />
                    ) : (
                      <input value={profile[f.key]} onChange={(e) => setProfile((p) => ({ ...p, [f.key]: e.target.value }))}
                        style={{ width: "100%", padding: "10px 12px", borderRadius: 10, border: "1.5px solid #E8DDD0", fontSize: 14, fontFamily: "inherit", background: "#FFFCF8", outline: "none" }} />
                    )}
                  </div>
                ))}
                <div style={{ display: "flex", gap: 10, marginTop: 8, marginBottom: 40 }}>
                  <button onClick={saveProfile} style={{ flex: 1, padding: 14, borderRadius: 14, border: "none", background: "linear-gradient(135deg,#FF8C42,#FF6B35)", color: "white", fontSize: 15, fontWeight: 600, cursor: "pointer" }}>
                    {saved ? "âœ… Update & Save" : "ğŸ’¾ Save My Info"}
                  </button>
                  <button onClick={() => setPanel(null)} style={{ padding: "14px 20px", borderRadius: 14, border: "1.5px solid #E8DDD0", background: "white", color: "#8B7B6B", fontSize: 15, cursor: "pointer" }}>Back</button>
                </div>
              </div>
            </div>
          )}

          {/* Memory Panel */}
          {panel === "memory" && (
            <div style={{ position: "absolute", top: 57, left: 0, right: 0, bottom: 0, background: "white", zIndex: 10, overflowY: "auto", padding: "20px 16px" }}>
              <div style={{ maxWidth: 500, margin: "0 auto" }}>
                <div style={{ textAlign: "center", marginBottom: 20 }}>
                  <div style={{ fontSize: 36, marginBottom: 8 }}>ğŸ§ </div>
                  <h2 style={{ fontSize: 20, fontWeight: 700, color: "#2D2D2D", marginBottom: 6 }}>Judy's Memory</h2>
                  <p style={{ color: "#8B7B6B", fontSize: 13, lineHeight: 1.5 }}>Things Judy has learned about your family from your conversations. Remove anything that's wrong!</p>
                </div>
                {memories.length === 0 ? (
                  <div style={{ textAlign: "center", padding: "40px 20px" }}>
                    <div style={{ fontSize: 40, marginBottom: 12 }}>ğŸ’­</div>
                    <p style={{ color: "#8B7B6B", fontSize: 14, lineHeight: 1.5 }}>
                      No memories yet! As you chat with Judy, she'll automatically pick up on your family's preferences, favorites, and needs.
                    </p>
                  </div>
                ) : (
                  <div style={{ display: "flex", flexDirection: "column", gap: 8, marginBottom: 40 }}>
                    {memories.map((m) => (
                      <div key={m.id} style={{ display: "flex", alignItems: "flex-start", gap: 10, padding: "12px 14px", borderRadius: 12, border: "1.5px solid #F0E6D9", background: "#FFFCF8" }}>
                        <div style={{ flex: 1 }}>
                          <div style={{ fontSize: 10, fontWeight: 600, color: "#B8936A", textTransform: "uppercase", letterSpacing: "0.5px", marginBottom: 4 }}>
                            {CATEGORY_LABELS[m.category] || m.category}
                          </div>
                          <div style={{ fontSize: 14, color: "#3D3D3D", lineHeight: 1.4 }}>{m.memory}</div>
                        </div>
                        <button onClick={() => deleteMemory(m.id)} className="mem-del"
                          style={{ padding: "4px 8px", borderRadius: 8, border: "1px solid #E8DDD0", background: "#FFF", color: "#B8936A", fontSize: 12, cursor: "pointer", flexShrink: 0 }}>
                          âœ•
                        </button>
                      </div>
                    ))}
                  </div>
                )}
                <div style={{ marginBottom: 40 }}>
                  <button onClick={() => setPanel(null)} style={{ width: "100%", padding: 14, borderRadius: 14, border: "1.5px solid #E8DDD0", background: "white", color: "#8B7B6B", fontSize: 15, cursor: "pointer" }}>Back</button>
                </div>
              </div>
            </div>
          )}

          {/* Skills Panel */}
          {panel === "skills" && (
            <div style={{ position: "absolute", top: 57, left: 0, right: 0, bottom: 0, background: "white", zIndex: 10, overflowY: "auto", padding: "20px 16px" }}>
              <div style={{ maxWidth: 500, margin: "0 auto" }}>
                <div style={{ textAlign: "center", marginBottom: 20 }}>
                  <div style={{ fontSize: 36, marginBottom: 8 }}>ğŸ“š</div>
                  <h2 style={{ fontSize: 20, fontWeight: 700, color: "#2D2D2D", marginBottom: 6 }}>Teach Me, Judy!</h2>
                  <p style={{ color: "#8B7B6B", fontSize: 13, lineHeight: 1.5 }}>Pick a topic and Judy will break it down simply. No chef school required!</p>
                </div>
                <div style={{ display: "flex", flexDirection: "column", gap: 8, marginBottom: 24 }}>
                  {SKILL_TOPICS.map((t, i) => (
                    <button key={i} onClick={() => send(t.text)} className="skill-btn"
                      style={{ display: "flex", alignItems: "center", gap: 12, padding: "14px 16px", borderRadius: 14, border: "1.5px solid #F0E6D9", background: "#FFFCF8", cursor: "pointer", textAlign: "left", width: "100%" }}>
                      <span style={{ fontSize: 24, flexShrink: 0 }}>{t.emoji}</span>
                      <span style={{ fontSize: 14, fontWeight: 500, color: "#3D3D3D" }}>{t.label}</span>
                    </button>
                  ))}
                </div>
                <div style={{ padding: 16, borderRadius: 14, background: "#FFF8F0", border: "1.5px dashed #FFD4B8", marginBottom: 40 }}>
                  <p style={{ fontSize: 13, color: "#8B6B4A", lineHeight: 1.5 }}>
                    ğŸ’¡ <strong>Don't see what you need?</strong> Just type "teach me how to..." followed by anything you want to learn!
                  </p>
                </div>
              </div>
            </div>
          )}

          {/* Messages */}
          <div style={{ flex: 1, overflowY: "auto", padding: "16px 12px" }}>
            {welcome && msgs.length === 0 && (
              <div style={{ textAlign: "center", padding: "30px 20px" }}>
                <div style={{ fontSize: 48, marginBottom: 10 }}>ğŸ‘©â€ğŸ³</div>
                <h2 style={{ fontSize: 22, fontWeight: 700, color: "#2D2D2D", marginBottom: 6 }}>Hey {userName}! ğŸ‘‹</h2>
                <p style={{ color: "#6B6B6B", fontSize: 14, marginBottom: 8, lineHeight: 1.5 }}>
                  I'm Judy, your meal planning partner. I'm here to make feeding your family feel less like a chore and more like you've totally got this.
                </p>
                {!saved && (
                  <div style={{ padding: "14px 18px", borderRadius: 14, background: "#FFF3EB", border: "1.5px solid #FFD4B8", margin: "16px auto", maxWidth: 360, textAlign: "left" }}>
                    <p style={{ fontSize: 13, color: "#8B5E3C", lineHeight: 1.5 }}>
                      ğŸ‘† <strong>First time here?</strong> Tap <strong>"My Family"</strong> up top to tell me about your crew so I can give you personalized help!
                    </p>
                  </div>
                )}
                <p style={{ color: "#9B8B7B", fontSize: 13, margin: "16px 0 20px" }}>What can I help with today?</p>
                <div style={{ display: "flex", flexWrap: "wrap", gap: 8, justifyContent: "center" }}>
                  {QUICK_PROMPTS.map((qp, i) => (
                    <button key={i} onClick={() => { setInput(qp.text); taRef.current?.focus(); }} className="qp-btn"
                      style={{ padding: "10px 16px", borderRadius: 20, border: "1.5px solid #FFD4B8", background: "white", color: "#D4652A", fontSize: 13, fontWeight: 500, cursor: "pointer" }}>
                      {qp.label}
                    </button>
                  ))}
                </div>
              </div>
            )}

            {msgs.map((m, i) => (
              <div key={i} style={{ display: "flex", justifyContent: m.role === "user" ? "flex-end" : "flex-start", marginBottom: 12 }}>
                <div style={{
                  maxWidth: "85%", padding: "12px 16px", borderRadius: 18, fontSize: 14, lineHeight: 1.55,
                  background: m.role === "user" ? "linear-gradient(135deg,#FF8C42,#FF6B35)" : "#F5F0EB",
                  color: m.role === "user" ? "white" : "#2D2D2D",
                  borderBottomRightRadius: m.role === "user" ? 4 : 18,
                  borderBottomLeftRadius: m.role === "user" ? 18 : 4,
                  boxShadow: "0 1px 2px rgba(0,0,0,.06)",
                }}>
                  {(m._imgs || []).map((src, j) => (
                    <img key={j} src={src} alt="" style={{ maxWidth: 200, maxHeight: 200, borderRadius: 10, display: "block", marginBottom: 8 }} />
                  ))}
                  {m.role === "user" ? <span>{m._text}</span> : <div>{fmt(m._text)}</div>}
                </div>
              </div>
            ))}

            {loading && (
              <div style={{ display: "flex", justifyContent: "flex-start", marginBottom: 12 }}>
                <div style={{ padding: "14px 20px", borderRadius: 18, borderBottomLeftRadius: 4, background: "#F5F0EB", display: "flex", gap: 6, alignItems: "center" }}>
                  <div style={{ width: 8, height: 8, borderRadius: "50%", background: "#D4A574", animation: "jbounce 1.2s ease-in-out 0s infinite" }} />
                  <div style={{ width: 8, height: 8, borderRadius: "50%", background: "#D4A574", animation: "jbounce 1.2s ease-in-out .15s infinite" }} />
                  <div style={{ width: 8, height: 8, borderRadius: "50%", background: "#D4A574", animation: "jbounce 1.2s ease-in-out .3s infinite" }} />
                </div>
              </div>
            )}
            <div ref={endRef} />
          </div>

          {/* Image Previews */}
          {images.length > 0 && (
            <div style={{ padding: "8px 16px", display: "flex", gap: 8, flexWrap: "wrap", borderTop: "1px solid #F0E6D9", background: "#FFFBF7", flexShrink: 0 }}>
              {images.map((img, i) => (
                <div key={i} style={{ position: "relative" }}>
                  <img src={img.preview} alt="" style={{ width: 60, height: 60, objectFit: "cover", borderRadius: 10, border: "2px solid #FFD4B8" }} />
                  <button onClick={() => setImages((p) => p.filter((_, j) => j !== i))} style={{
                    position: "absolute", top: -6, right: -6, width: 20, height: 20, borderRadius: "50%",
                    background: "#FF6B35", color: "white", border: "none", fontSize: 12, cursor: "pointer",
                    display: "flex", alignItems: "center", justifyContent: "center",
                  }}>Ã—</button>
                </div>
              ))}
            </div>
          )}

          {/* Input */}
          <div style={{ padding: "10px 16px 18px", borderTop: "1px solid #F0E6D9", background: "white", flexShrink: 0 }}>
            <div style={{ display: "flex", alignItems: "flex-end", gap: 8, background: "#F9F5F0", borderRadius: 24, padding: "6px 6px 6px 16px", border: "1.5px solid #EDE4DA" }}>
              <button onClick={() => fileRef.current?.click()} style={{ width: 36, height: 36, borderRadius: "50%", border: "none", background: "transparent", cursor: "pointer", fontSize: 20, display: "flex", alignItems: "center", justifyContent: "center", color: "#B8936A", flexShrink: 0 }}>ğŸ“·</button>
              <input ref={fileRef} type="file" accept="image/*" multiple onChange={onFiles} style={{ display: "none" }} />
              <textarea ref={taRef} value={input} onChange={(e) => setInput(e.target.value)}
                onKeyDown={(e) => { if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); send(); } }}
                placeholder="Ask Judy anything..." rows={1}
                style={{ flex: 1, border: "none", background: "transparent", resize: "none", fontSize: 15, color: "#2D2D2D", outline: "none", padding: "8px 0", fontFamily: "inherit", lineHeight: 1.4, maxHeight: 120 }} />
              <button onClick={() => send()} disabled={loading}
                style={{ width: 36, height: 36, borderRadius: "50%", background: (input.trim() || images.length > 0) ? "linear-gradient(135deg,#FF8C42,#FF6B35)" : "#DDD", border: "none", cursor: loading ? "wait" : "pointer", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 16, color: "white", flexShrink: 0 }}>
                â†‘
              </button>
            </div>
          </div>
        </div>
      );
    }

    // â”€â”€â”€ App (top-level auth wrapper) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function App() {
      const [authState, setAuthState] = useState("loading"); // loading | login | onboarding | ready
      const [session, setSession] = useState(null);
      const [userName, setUserName] = useState("");
      const [supabaseClient, setSupabaseClient] = useState(null);

      useEffect(() => {
        // Init Supabase client from server config
        fetch("/api/auth/config")
          .then((r) => r.json())
          .then(({ supabaseUrl, supabaseAnonKey }) => {
            const client = window.supabase.createClient(supabaseUrl, supabaseAnonKey);
            _supabaseClient = client;
            setSupabaseClient(client);

            // onAuthStateChange handles everything: initial load, sign-in, sign-out, token refresh
            const { data: { subscription } } = client.auth.onAuthStateChange(async (event, s) => {
              setSession(s);
              if (s && (event === "INITIAL_SESSION" || event === "SIGNED_IN" || event === "TOKEN_REFRESHED")) {
                // For returning users, refresh the session to get a valid token
                if (event === "INITIAL_SESSION") {
                  const { data: refreshed } = await client.auth.refreshSession();
                  if (refreshed.session) {
                    checkProfile(refreshed.session);
                  } else {
                    setAuthState("login");
                  }
                } else {
                  checkProfile(s);
                }
              } else if (event === "SIGNED_OUT" || (event === "INITIAL_SESSION" && !s)) {
                setSession(null);
                setUserName("");
                setAuthState("login");
              }
            });

            return () => subscription.unsubscribe();
          })
          .catch((err) => {
            console.error("Failed to init auth:", err);
            setAuthState("login");
          });
      }, []);

      const checkProfile = async (s) => {
        try {
          const res = await authFetch("/api/profile");
          const data = await res.json();
          if (data.profile && data.profile.name) {
            setUserName(data.profile.name);
            setAuthState("ready");
          } else {
            setAuthState("onboarding");
          }
        } catch {
          setAuthState("onboarding");
        }
      };

      const handleOnboardingComplete = (name) => {
        setUserName(name);
        setAuthState("ready");
      };

      if (authState === "loading" || !supabaseClient) return <LoadingScreen />;
      if (authState === "login") return <LoginScreen supabaseClient={supabaseClient} />;
      if (authState === "onboarding") return <OnboardingScreen onComplete={handleOnboardingComplete} />;
      return <AskJudy session={session} userName={userName} supabaseClient={supabaseClient} />;
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
